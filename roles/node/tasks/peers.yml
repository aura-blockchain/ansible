---
# Peers Configuration Tasks

- name: Download peers file
  ansible.builtin.get_url:
    url: "{{ node_peers_url }}"
    dest: "/tmp/peers.txt"
    mode: "0644"
  when: node_peers_url | length > 0

- name: Read peers from downloaded file
  ansible.builtin.slurp:
    src: /tmp/peers.txt
  register: node_peers_file_content
  when: node_peers_url | length > 0

- name: Set persistent peers from downloaded file
  ansible.builtin.set_fact:
    node_persistent_peers: >-
      {{ (node_peers_file_content.content | b64decode).split('\n')
         | reject('match', '^#')
         | reject('match', '^$')
         | map('trim')
         | select()
         | join(',') }}
  when:
    - node_peers_url | length > 0
    - node_persistent_peers | length == 0

- name: Clean up peers file
  ansible.builtin.file:
    path: /tmp/peers.txt
    state: absent
  when: node_peers_url | length > 0

- name: Display configured peers
  ansible.builtin.debug:
    msg: "Persistent peers: {{ node_persistent_peers }}"
  when: node_persistent_peers | length > 0
