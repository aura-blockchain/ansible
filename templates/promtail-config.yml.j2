# Promtail configuration
# Generated by Ansible - DO NOT EDIT MANUALLY

server:
  http_listen_port: {{ promtail_http_port | default(9080) }}
  grpc_listen_port: {{ promtail_grpc_port | default(0) }}

positions:
  filename: /var/lib/promtail/positions.yaml

clients:
  - url: {{ loki_push_url | default('http://localhost:3100/loki/api/v1/push') }}
{% if loki_basic_auth_user is defined %}
    basic_auth:
      username: {{ loki_basic_auth_user }}
      password: {{ vault_loki_basic_auth_password }}
{% endif %}
{% if loki_tenant_id is defined %}
    tenant_id: {{ loki_tenant_id }}
{% endif %}

scrape_configs:
  # Scrape systemd journal logs
  - job_name: journal
    journal:
      json: false
      max_age: 12h
      path: /var/log/journal
      labels:
        job: systemd-journal
        host: {{ ansible_hostname }}
        chain: {{ chain_id | default('aura-mvp-1') }}
    relabel_configs:
      # Keep only specific systemd units
      - source_labels: ['__journal__systemd_unit']
        regex: '(aurad.*|cosmovisor.*|tenderduty.*|cosmos-exporter.*|node_exporter.*).service'
        action: keep
      # Add unit label
      - source_labels: ['__journal__systemd_unit']
        target_label: unit
      # Add priority label
      - source_labels: ['__journal_priority_keyword']
        target_label: priority
    pipeline_stages:
      # Extract block height from aurad logs
      - regex:
          expression: 'height=(?P<height>\d+)'
      - labels:
          height:
      # Extract module from log messages
      - regex:
          expression: 'module=(?P<module>\w+)'
      - labels:
          module:
      # Extract error level
      - regex:
          expression: 'level=(?P<level>\w+)'
      - labels:
          level:

{% if enable_aurad_log_files | default(false) %}
  # Scrape aurad log files directly (if not using journald)
  - job_name: aurad-logs
    static_configs:
      - targets:
          - localhost
        labels:
          job: aurad
          host: {{ ansible_hostname }}
          chain: {{ chain_id | default('aura-mvp-1') }}
          __path__: {{ daemon_home | default('~/.aura') }}/logs/*.log
    pipeline_stages:
      - regex:
          expression: 'height=(?P<height>\d+)'
      - labels:
          height:
      - regex:
          expression: 'module=(?P<module>\w+)'
      - labels:
          module:
      - regex:
          expression: 'level=(?P<level>\w+)'
      - labels:
          level:
{% endif %}

{% if additional_scrape_configs is defined %}
{{ additional_scrape_configs | to_nice_yaml(indent=2) | indent(2) }}
{% endif %}
