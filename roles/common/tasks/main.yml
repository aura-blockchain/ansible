---
# Common role - Base system configuration
# Installs packages, hardens SSH, configures firewall, fail2ban, sysctl, ulimits

- name: Update apt cache
  ansible.builtin.apt:
    update_cache: true
    cache_valid_time: 3600
  become: true

- name: Install base packages
  ansible.builtin.apt:
    name:
      - curl
      - wget
      - git
      - vim
      - htop
      - tmux
      - jq
      - make
      - gcc
      - build-essential
      - lz4
      - unzip
      - ufw
      - fail2ban
      - logrotate
      - ca-certificates
      - gnupg
      - software-properties-common
      - net-tools
      - iotop
      - sysstat
    state: present
  become: true

# SSH Hardening
- name: Configure SSH - Disable root login
  ansible.builtin.lineinfile:
    path: /etc/ssh/sshd_config
    regexp: '^#?PermitRootLogin'
    line: 'PermitRootLogin no'
    state: present
  become: true
  notify: Restart SSH

- name: Configure SSH - Disable password authentication
  ansible.builtin.lineinfile:
    path: /etc/ssh/sshd_config
    regexp: '^#?PasswordAuthentication'
    line: 'PasswordAuthentication no'
    state: present
  become: true
  notify: Restart SSH

- name: Configure SSH - Disable empty passwords
  ansible.builtin.lineinfile:
    path: /etc/ssh/sshd_config
    regexp: '^#?PermitEmptyPasswords'
    line: 'PermitEmptyPasswords no'
    state: present
  become: true
  notify: Restart SSH

- name: Configure SSH - Use protocol 2 only
  ansible.builtin.lineinfile:
    path: /etc/ssh/sshd_config
    regexp: '^#?Protocol'
    line: 'Protocol 2'
    state: present
  become: true
  notify: Restart SSH

- name: Configure SSH - Max auth tries
  ansible.builtin.lineinfile:
    path: /etc/ssh/sshd_config
    regexp: '^#?MaxAuthTries'
    line: 'MaxAuthTries {{ common_ssh_max_auth_tries | default(3) }}'
    state: present
  become: true
  notify: Restart SSH

# UFW Firewall
- name: Enable UFW
  community.general.ufw:
    state: enabled
    policy: deny
  become: true

- name: Allow SSH through UFW
  community.general.ufw:
    rule: allow
    port: '{{ common_ssh_port | default(22) }}'
    proto: tcp
  become: true

- name: Allow established connections
  community.general.ufw:
    rule: allow
    direction: in
    from_ip: any
    to_ip: any
    route: false
    comment: 'Allow established connections'
  become: true
  failed_when: false

# Fail2ban
- name: Configure fail2ban jail.local
  ansible.builtin.copy:
    dest: /etc/fail2ban/jail.local
    content: |
      [DEFAULT]
      bantime = {{ common_fail2ban_bantime | default('1h') }}
      findtime = {{ common_fail2ban_findtime | default('10m') }}
      maxretry = {{ common_fail2ban_maxretry | default(5) }}
      ignoreip = 127.0.0.1/8 ::1 {{ common_fail2ban_ignoreip | default('') }}

      [sshd]
      enabled = true
      port = {{ common_ssh_port | default(22) }}
      filter = sshd
      logpath = /var/log/auth.log
      maxretry = {{ common_fail2ban_ssh_maxretry | default(3) }}
    mode: '0644'
  become: true
  notify: Restart Fail2ban

- name: Enable and start fail2ban
  ansible.builtin.service:
    name: fail2ban
    enabled: true
    state: started
  become: true

# Sysctl tuning for blockchain nodes
- name: Configure sysctl for blockchain node
  ansible.posix.sysctl:
    name: "{{ item.name }}"
    value: "{{ item.value }}"
    sysctl_set: true
    state: present
    reload: true
  become: true
  loop:
    - { name: 'net.core.somaxconn', value: '65535' }
    - { name: 'net.core.netdev_max_backlog', value: '65535' }
    - { name: 'net.ipv4.tcp_max_syn_backlog', value: '65535' }
    - { name: 'net.ipv4.tcp_tw_reuse', value: '1' }
    - { name: 'net.ipv4.ip_local_port_range', value: '1024 65535' }
    - { name: 'net.ipv4.tcp_fin_timeout', value: '30' }
    - { name: 'net.ipv4.tcp_keepalive_time', value: '300' }
    - { name: 'net.ipv4.tcp_keepalive_probes', value: '5' }
    - { name: 'net.ipv4.tcp_keepalive_intvl', value: '15' }
    - { name: 'fs.file-max', value: '2097152' }
    - { name: 'vm.swappiness', value: '10' }
    - { name: 'vm.dirty_ratio', value: '60' }
    - { name: 'vm.dirty_background_ratio', value: '2' }
  notify: Reload Sysctl

# Ulimits for blockchain processes
- name: Configure ulimits for blockchain
  ansible.builtin.copy:
    dest: /etc/security/limits.d/99-blockchain.conf
    content: |
      # Blockchain node ulimits
      *               soft    nofile          1048576
      *               hard    nofile          1048576
      *               soft    nproc           unlimited
      *               hard    nproc           unlimited
      root            soft    nofile          1048576
      root            hard    nofile          1048576
    mode: '0644'
  become: true

- name: Configure PAM to use limits
  ansible.builtin.lineinfile:
    path: /etc/pam.d/common-session
    line: 'session required pam_limits.so'
    state: present
  become: true

- name: Configure PAM noninteractive to use limits
  ansible.builtin.lineinfile:
    path: /etc/pam.d/common-session-noninteractive
    line: 'session required pam_limits.so'
    state: present
  become: true

# Timezone
- name: Set timezone to UTC
  community.general.timezone:
    name: "{{ common_timezone | default('UTC') }}"
  become: true
