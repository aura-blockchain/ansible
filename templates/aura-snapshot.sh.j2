#!/bin/bash
# AURA Blockchain Snapshot Script
# Generated by Ansible - DO NOT EDIT MANUALLY
#
# This script creates a compressed snapshot of the blockchain data
# for state-sync bootstrapping of new nodes.

set -euo pipefail

# Configuration
CHAIN_ID="{{ chain_id | default('aura-mvp-1') }}"
DAEMON_HOME="{{ daemon_home | default('~/.aura') }}"
SNAPSHOT_DIR="{{ snapshot_dir | default('/var/snapshots/aura') }}"
SERVICE_NAME="{{ service_name | default('aurad') }}"
RPC_PORT="{{ rpc_port | default(26657) }}"
KEEP_SNAPSHOTS="{{ keep_snapshots | default(3) }}"

# Expand home directory if needed
DAEMON_HOME=$(eval echo "$DAEMON_HOME")

# Logging function
log() {
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] $1"
}

error_exit() {
    log "ERROR: $1"
    exit 1
}

# Ensure snapshot directory exists
mkdir -p "$SNAPSHOT_DIR"

# Get current block height
log "Fetching current block height..."
HEIGHT=$(curl -sf "http://127.0.0.1:${RPC_PORT}/status" | jq -r '.result.sync_info.latest_block_height')

if [[ -z "$HEIGHT" || "$HEIGHT" == "null" ]]; then
    error_exit "Failed to get block height from RPC"
fi

log "Current block height: $HEIGHT"

# Generate snapshot filename
TIMESTAMP=$(date +%Y%m%d_%H%M%S)
SNAPSHOT_NAME="${CHAIN_ID}-${HEIGHT}-${TIMESTAMP}.tar.lz4"
SNAPSHOT_PATH="${SNAPSHOT_DIR}/${SNAPSHOT_NAME}"

# Stop the service
log "Stopping ${SERVICE_NAME} service..."
sudo systemctl stop "$SERVICE_NAME" || error_exit "Failed to stop service"

# Wait for service to fully stop
sleep 5

# Verify service is stopped
if systemctl is-active --quiet "$SERVICE_NAME"; then
    log "WARNING: Service still running, waiting longer..."
    sleep 10
    if systemctl is-active --quiet "$SERVICE_NAME"; then
        sudo systemctl start "$SERVICE_NAME"
        error_exit "Service did not stop cleanly"
    fi
fi

# Create snapshot
log "Creating snapshot: $SNAPSHOT_NAME"
cd "$DAEMON_HOME" || error_exit "Cannot access daemon home directory"

# Create tar archive with lz4 compression
# Exclude wasm cache and other non-essential files
tar -cf - \
    --exclude='wasm/cache' \
    --exclude='wasm/wasm/cache' \
    --exclude='*.log' \
    --exclude='priv_validator_state.json' \
    data/ \
    | lz4 -9 > "$SNAPSHOT_PATH" || {
        sudo systemctl start "$SERVICE_NAME"
        error_exit "Failed to create snapshot archive"
    }

# Restart the service
log "Restarting ${SERVICE_NAME} service..."
sudo systemctl start "$SERVICE_NAME" || error_exit "Failed to restart service"

# Verify service is running
sleep 5
if ! systemctl is-active --quiet "$SERVICE_NAME"; then
    error_exit "Service failed to start after snapshot"
fi

# Get snapshot file size
SNAPSHOT_SIZE=$(stat -c%s "$SNAPSHOT_PATH")
SNAPSHOT_SIZE_MB=$((SNAPSHOT_SIZE / 1024 / 1024))

log "Snapshot created successfully: ${SNAPSHOT_SIZE_MB}MB"

# Create latest.json metadata
LATEST_JSON="${SNAPSHOT_DIR}/latest.json"
cat > "$LATEST_JSON" << EOF
{
    "chain_id": "${CHAIN_ID}",
    "height": ${HEIGHT},
    "timestamp": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
    "filename": "${SNAPSHOT_NAME}",
    "size_bytes": ${SNAPSHOT_SIZE},
    "size_mb": ${SNAPSHOT_SIZE_MB},
    "checksum": "$(sha256sum "$SNAPSHOT_PATH" | awk '{print $1}')"
}
EOF

log "Updated latest.json metadata"

# Cleanup old snapshots (keep last N)
log "Cleaning up old snapshots (keeping last ${KEEP_SNAPSHOTS})..."
cd "$SNAPSHOT_DIR"

# List snapshots by modification time, skip the latest ones
SNAPSHOTS_TO_DELETE=$(ls -t ${CHAIN_ID}-*.tar.lz4 2>/dev/null | tail -n +$((KEEP_SNAPSHOTS + 1)))

if [[ -n "$SNAPSHOTS_TO_DELETE" ]]; then
    for old_snapshot in $SNAPSHOTS_TO_DELETE; do
        log "Removing old snapshot: $old_snapshot"
        rm -f "$old_snapshot"
    done
else
    log "No old snapshots to clean up"
fi

# Final status
log "Snapshot process completed successfully"
log "  Chain ID: $CHAIN_ID"
log "  Height: $HEIGHT"
log "  File: $SNAPSHOT_PATH"
log "  Size: ${SNAPSHOT_SIZE_MB}MB"

exit 0
