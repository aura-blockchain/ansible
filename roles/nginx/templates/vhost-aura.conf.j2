# Managed by Ansible - DO NOT EDIT MANUALLY
# AURA testnet virtual hosts - Community standards compliant

# =============================================================================
# RPC Endpoint
# =============================================================================

# HTTP → HTTPS redirect
server {
    listen 80;
    listen [::]:80;
    server_name testnet-rpc.{{ nginx_domain }};
    return 301 https://$server_name$request_uri;
}

# HTTPS server
server {
    listen 443 ssl http2;
    listen [::]:443 ssl http2;
    server_name testnet-rpc.{{ nginx_domain }};

    # SSL certificates
    ssl_certificate /etc/letsencrypt/live/testnet-rpc.{{ nginx_domain }}/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/testnet-rpc.{{ nginx_domain }}/privkey.pem;

    # HSTS (31536000 seconds = 1 year)
    add_header Strict-Transport-Security "max-age=31536000; includeSubDomains; preload" always;

    # CORS headers for dApp integration
    add_header Access-Control-Allow-Origin "{{ nginx_cors_origin | default('*') }}" always;
    add_header Access-Control-Allow-Methods "GET, POST, OPTIONS" always;
    add_header Access-Control-Allow-Headers "DNT,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type,Range,Authorization" always;
    add_header Access-Control-Expose-Headers "Content-Length,Content-Range" always;

    # Handle preflight requests
    if ($request_method = 'OPTIONS') {
        add_header Access-Control-Allow-Origin "{{ nginx_cors_origin | default('*') }}";
        add_header Access-Control-Allow-Methods "GET, POST, OPTIONS";
        add_header Access-Control-Allow-Headers "DNT,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type,Range,Authorization";
        add_header Access-Control-Max-Age 1728000;
        add_header Content-Type 'text/plain; charset=utf-8';
        add_header Content-Length 0;
        return 204;
    }

    # Connection limit
    limit_conn conn_limit {{ nginx_conn_limit | default(10) }};

    location / {
        # Rate limiting
        limit_req zone=api burst={{ nginx_api_burst | default(20) }} nodelay;

        proxy_pass http://127.0.0.1:{{ nginx_rpc_port }};
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header Connection "";

        # Timeouts for blockchain queries
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;

        # Buffer settings
        proxy_buffering on;
        proxy_buffer_size 4k;
        proxy_buffers 8 4k;
    }

    # Health check endpoint (no rate limit)
    location /health {
        proxy_pass http://127.0.0.1:{{ nginx_rpc_port }}/health;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
    }
}

# =============================================================================
# REST API Endpoint
# =============================================================================

# HTTP → HTTPS redirect
server {
    listen 80;
    listen [::]:80;
    server_name testnet-api.{{ nginx_domain }};
    return 301 https://$server_name$request_uri;
}

# HTTPS server
server {
    listen 443 ssl http2;
    listen [::]:443 ssl http2;
    server_name testnet-api.{{ nginx_domain }};

    # SSL certificates
    ssl_certificate /etc/letsencrypt/live/testnet-api.{{ nginx_domain }}/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/testnet-api.{{ nginx_domain }}/privkey.pem;

    # HSTS
    add_header Strict-Transport-Security "max-age=31536000; includeSubDomains; preload" always;

    # CORS headers for dApp integration
    add_header Access-Control-Allow-Origin "{{ nginx_cors_origin | default('*') }}" always;
    add_header Access-Control-Allow-Methods "GET, POST, OPTIONS" always;
    add_header Access-Control-Allow-Headers "DNT,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type,Range,Authorization" always;
    add_header Access-Control-Expose-Headers "Content-Length,Content-Range" always;

    # Handle preflight requests
    if ($request_method = 'OPTIONS') {
        add_header Access-Control-Allow-Origin "{{ nginx_cors_origin | default('*') }}";
        add_header Access-Control-Allow-Methods "GET, POST, OPTIONS";
        add_header Access-Control-Allow-Headers "DNT,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type,Range,Authorization";
        add_header Access-Control-Max-Age 1728000;
        add_header Content-Type 'text/plain; charset=utf-8';
        add_header Content-Length 0;
        return 204;
    }

    # Connection limit
    limit_conn conn_limit {{ nginx_conn_limit | default(10) }};

    location / {
        # Rate limiting
        limit_req zone=api burst={{ nginx_api_burst | default(20) }} nodelay;

        proxy_pass http://127.0.0.1:{{ nginx_rest_port }};
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header Connection "";

        # Timeouts
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
    }

    # Swagger/OpenAPI docs (if enabled)
    location /swagger/ {
        proxy_pass http://127.0.0.1:{{ nginx_rest_port }}/swagger/;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
    }
}

# =============================================================================
# gRPC Endpoint
# =============================================================================

# HTTP → HTTPS redirect
server {
    listen 80;
    listen [::]:80;
    server_name testnet-grpc.{{ nginx_domain }};
    return 301 https://$server_name$request_uri;
}

# gRPC over HTTPS (HTTP/2 required)
server {
    listen 443 ssl http2;
    listen [::]:443 ssl http2;
    server_name testnet-grpc.{{ nginx_domain }};

    # SSL certificates
    ssl_certificate /etc/letsencrypt/live/testnet-grpc.{{ nginx_domain }}/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/testnet-grpc.{{ nginx_domain }}/privkey.pem;

    # HSTS
    add_header Strict-Transport-Security "max-age=31536000; includeSubDomains; preload" always;

    # Connection limit
    limit_conn conn_limit {{ nginx_conn_limit | default(10) }};

    location / {
        # Rate limiting
        limit_req zone=api burst={{ nginx_api_burst | default(20) }} nodelay;

        grpc_pass grpc://127.0.0.1:{{ nginx_grpc_port }};

        # gRPC timeouts
        grpc_connect_timeout 60s;
        grpc_send_timeout 60s;
        grpc_read_timeout 60s;
    }
}

# =============================================================================
# WebSocket Endpoint (Tendermint RPC WebSocket)
# =============================================================================

# HTTP → HTTPS redirect
server {
    listen 80;
    listen [::]:80;
    server_name testnet-ws.{{ nginx_domain }};
    return 301 https://$server_name$request_uri;
}

# HTTPS server with WebSocket support
server {
    listen 443 ssl http2;
    listen [::]:443 ssl http2;
    server_name testnet-ws.{{ nginx_domain }};

    # SSL certificates
    ssl_certificate /etc/letsencrypt/live/testnet-ws.{{ nginx_domain }}/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/testnet-ws.{{ nginx_domain }}/privkey.pem;

    # HSTS
    add_header Strict-Transport-Security "max-age=31536000; includeSubDomains; preload" always;

    # CORS for WebSocket
    add_header Access-Control-Allow-Origin "{{ nginx_cors_origin | default('*') }}" always;

    location / {
        proxy_pass http://127.0.0.1:{{ nginx_ws_port }};
        proxy_http_version 1.1;

        # WebSocket upgrade headers
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection $connection_upgrade;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # Long timeout for WebSocket connections (24 hours)
        proxy_read_timeout 86400s;
        proxy_send_timeout 86400s;

        # Disable buffering for real-time data
        proxy_buffering off;
    }

    # WebSocket endpoint at /websocket
    location /websocket {
        proxy_pass http://127.0.0.1:{{ nginx_ws_port }}/websocket;
        proxy_http_version 1.1;

        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection $connection_upgrade;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;

        proxy_read_timeout 86400s;
        proxy_send_timeout 86400s;
        proxy_buffering off;
    }
}

# =============================================================================
# Explorer
# =============================================================================

# HTTP → HTTPS redirect
server {
    listen 80;
    listen [::]:80;
    server_name testnet-explorer.{{ nginx_domain }};
    return 301 https://$server_name$request_uri;
}

# HTTPS server
server {
    listen 443 ssl http2;
    listen [::]:443 ssl http2;
    server_name testnet-explorer.{{ nginx_domain }};

    # SSL certificates
    ssl_certificate /etc/letsencrypt/live/testnet-explorer.{{ nginx_domain }}/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/testnet-explorer.{{ nginx_domain }}/privkey.pem;

    # HSTS
    add_header Strict-Transport-Security "max-age=31536000; includeSubDomains; preload" always;

    # CSP for explorer (allow inline scripts for some explorers)
    add_header Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval'; style-src 'self' 'unsafe-inline'; img-src 'self' data: https:; font-src 'self' data:; connect-src 'self' https://*.{{ nginx_domain }} wss://*.{{ nginx_domain }};" always;

    location / {
        proxy_pass http://127.0.0.1:{{ nginx_explorer_port }};
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # Cache static assets
        proxy_cache_valid 200 10m;
    }
}

# =============================================================================
# Faucet (stricter rate limiting)
# =============================================================================

# HTTP → HTTPS redirect
server {
    listen 80;
    listen [::]:80;
    server_name testnet-faucet.{{ nginx_domain }};
    return 301 https://$server_name$request_uri;
}

# HTTPS server
server {
    listen 443 ssl http2;
    listen [::]:443 ssl http2;
    server_name testnet-faucet.{{ nginx_domain }};

    # SSL certificates
    ssl_certificate /etc/letsencrypt/live/testnet-faucet.{{ nginx_domain }}/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/testnet-faucet.{{ nginx_domain }}/privkey.pem;

    # HSTS
    add_header Strict-Transport-Security "max-age=31536000; includeSubDomains; preload" always;

    # CSP for faucet
    add_header Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline'; img-src 'self' data:; connect-src 'self' https://*.{{ nginx_domain }};" always;

    # Stricter connection limit for faucet
    limit_conn conn_limit {{ nginx_faucet_conn_limit | default(5) }};

    location / {
        # Strict rate limiting for faucet (prevent abuse)
        limit_req zone=faucet burst={{ nginx_faucet_burst | default(5) }} nodelay;

        proxy_pass http://127.0.0.1:{{ nginx_faucet_port }};
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # API endpoint with even stricter limiting
    location /api/ {
        limit_req zone=faucet burst=2 nodelay;

        proxy_pass http://127.0.0.1:{{ nginx_faucet_port }}/api/;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
}

# =============================================================================
# Documentation Site
# =============================================================================

# HTTP → HTTPS redirect
server {
    listen 80;
    listen [::]:80;
    server_name docs.{{ nginx_domain }};
    return 301 https://$server_name$request_uri;
}

# HTTPS server
server {
    listen 443 ssl http2;
    listen [::]:443 ssl http2;
    server_name docs.{{ nginx_domain }};

    # SSL certificates
    ssl_certificate /etc/letsencrypt/live/docs.{{ nginx_domain }}/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/docs.{{ nginx_domain }}/privkey.pem;

    # HSTS
    add_header Strict-Transport-Security "max-age=31536000; includeSubDomains; preload" always;

    # Root directory for static docs
    root {{ nginx_docs_root | default('/var/www/docs') }};
    index index.html;

    location / {
        try_files $uri $uri/ /index.html;

        # Cache static assets
        location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2)$ {
            expires 30d;
            add_header Cache-Control "public, immutable";
        }
    }
}
